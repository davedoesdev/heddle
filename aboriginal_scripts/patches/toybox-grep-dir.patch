diff -ru toybox-0.5.2.orig/lib/portability.c toybox-0.5.2/lib/portability.c
--- toybox-0.5.2.orig/lib/portability.c	2015-02-26 02:42:24.000000000 +0000
+++ toybox-0.5.2/lib/portability.c	2015-03-13 20:07:48.017855796 +0000
@@ -45,7 +45,7 @@
       new_line = realloc(*linep, new_len);
       if (!new_line) return -1;
       *np = new_len;
-      *linep = new_line;
+      line = *linep = new_line;
     }
 
     line[i] = ch;
@@ -59,7 +59,7 @@
     new_line = realloc(*linep, new_len);
     if (!new_line) return -1;
     *np = new_len;
-    *linep = new_line;
+    line = *linep = new_line;
   }
   line[i + 1] = '\0';
 
diff -ru toybox-0.5.2.orig/toys/posix/grep.c toybox-0.5.2/toys/posix/grep.c
--- toybox-0.5.2.orig/toys/posix/grep.c	2015-02-26 02:42:24.000000000 +0000
+++ toybox-0.5.2/toys/posix/grep.c	2015-03-13 20:07:48.017855796 +0000
@@ -75,6 +75,17 @@
     return;
   }
 
+  struct stat stat;
+  if (fstat(fd, &stat) != 0) {
+    perror_msg("%s", name);
+    fclose(file);
+    return;
+  }
+  if (S_ISDIR(stat.st_mode)) {
+    fclose(file);
+    return;
+  }
+  
   for (;;) {
     char *line = 0, *start;
     regmatch_t matches[3];
